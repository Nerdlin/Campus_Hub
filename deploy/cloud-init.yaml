##cloud-config
packages:
  - nginx
  - git
  - ufw
  - curl
  - python3-certbot-nginx
write_files:
  - path: /etc/apt/sources.list.d/nodesource.list
    content: |
      deb [signed-by=/usr/share/keyrings/nodesource.gpg] https://deb.nodesource.com/node_22.x nodistro main
  - path: /usr/share/keyrings/nodesource.gpg
    encoding: b64
    content: |
      -----BEGIN PGP PUBLIC KEY BLOCK-----
      Version: GnuPG v1
      -----END PGP PUBLIC KEY BLOCK-----
runcmd:
  - apt-get update
  - apt-get -y upgrade
  - curl -fsSL https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key | gpg --dearmor -o /usr/share/keyrings/nodesource.gpg || true
  - apt-get update
  - apt-get -y install nodejs
  - ufw allow OpenSSH
  - ufw allow 'Nginx Full'
  - ufw --force enable
  - mkdir -p /var/www
  - cd /var/www
  - git clone REPO_URL Campus_Hub
  - chown -R www-data:www-data /var/www/Campus_Hub
  - cd /var/www/Campus_Hub
  - sudo -u www-data npm ci
  - sudo -u www-data npm run build
  - cp deploy/systemd/campus-hub.service /etc/systemd/system/campus-hub.service
  - cp deploy/systemd/campus-hub-api.service /etc/systemd/system/campus-hub-api.service
  - systemctl daemon-reload
  - systemctl enable --now campus-hub.service campus-hub-api.service
  - cp deploy/nginx/campus-hub.conf /etc/nginx/sites-available/campus-hub
  - ln -sf /etc/nginx/sites-available/campus-hub /etc/nginx/sites-enabled/campus-hub
  - nginx -t && systemctl reload nginx
final_message: "Campus Hub provisioned."


